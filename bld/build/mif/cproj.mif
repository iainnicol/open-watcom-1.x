!include preclude.mif

!ifndef lang_root
lang_root       = $(lang_root_$(host_cpu))
!endif

cc_386          = *wcc386
cc_i86          = *wcc
cc_axp          = *wccaxp
cc_ppc          = *wccppc

cl_386          = *wcl386
cl_i86          = *wcl
cl_axp          = *wclaxp
cl_ppc          = *wclppc

cpp_386         = *wpp386
cpp_i86         = *wpp
cpp_axp         = *wppaxp
cpp_ppc         = *wppppc

linker_386      = *wlink
linker_i86      = *wlink
linker_axp      = *wlink
linker_ppc      = *wlink

librarian_386   = *wlib
librarian_i86   = *wlib
librarian_axp   = *wlib
librarian_ppc   = *wlib

as_386          = *wasm
as_i86          = *wasm
as_axp          = *wasaxp
as_ppc          = *wasppc

!ifndef %use_os2tk_stuff
rc_os2_path = $(lang_root)\binp
!else
rc_os2_path = $(os2_toolkit)\bin
!endif

rc_os2      = $(rc_os2_path)\rc.exe

!ifeq host_os os2
%PATH = $+$(%PATH);$(%watcom)\binp$-
# this extra line appears to be needed
!endif
rc              = *wrc


!ifdef release_$(proj_name)
release = $(release_$(proj_name))
!else ifeq debug_build 1
release = 0
!else
release = 1
!endif

!ifdef $(proj_name)_debugfmt
debugfmt = $($(proj_name)_debugfmt)
!else ifeq %CODEVIEW 1
debugfmt = codeview
!else
debugfmt = dwarf
!endif

!ifeq debugfmt codeview
cdebug_fmt  = -hc
ldebug_fmt  = debug c
cldebug_fmt = -hc
!else ifeq debugfmt watcom # supported only on intel
cdebug_fmt  = -hw          # cg for axp and ppc don't use it
ldebug_fmt  = debug w
cldebug_fmt = -hw
!else
#cdebug_fmt  = -hd              # defaul format
ldebug_fmt  = debug d
cldebug_fmt = -hd
!endif

!ifeq release 1
mode_cflags   = -oaxt -d1-DNDEBUG $(cdebug_fmt)
mode_aflags   = -DNDEBUG
mode_lflags   = $(ldebug_fmt)
mode_clflags  = $(cldebug_fmt)
!else
mode_cflags   = -od -d2 $(cdebug_fmt)
mode_aflags   = -d1
mode_lflags   = $(ldebug_fmt) all
mode_clflags  = $(cldebug_fmt)
!endif

!ifndef $(proj_name)_nosymfile
mode_lflags    += option symfile
!ifdef __UNIX__
mode_clflags   += -\"option symfile\"
!else
mode_clflags   += -"option symfile"
!endif
!endif

!ifndef memory_model_i86
memory_model_i86 = l
!endif

!ifdef mem_model_i86
model_switch_i86        = $(mem_model_i86)
!else
model_switch_i86        = -m$(memory_model_i86)
!endif

!ifndef memory_model_386
memory_model_386 = f
!endif

!ifdef mem_model_386
model_switch_386        = $(mem_model_386)
!else ifdef memory_model_386
model_switch_386        = -m$(memory_model_386)
!endif

cflags_all      =-w4 -we $(mode_cflags)
!ifdef __LINUX__
cflags_all      += -fo=.obj
!endif

cflags_386      = $(model_switch_$(host_cpu))
cflags_i86      = $(model_switch_$(host_cpu))
cflags_axp      =
cflags_ppc      =

!ifndef suppress_zc
cflags_386      += -zc
!endif

cflags_nt       = -bt=nt
cflags_win      = -bt=windows
cflags_os2      = -bt=os2
cflags_qnx      = -bt=qnx
cflags_osi      = -bt=osi
cflags_dos      = -bt=dos
cflags_nov      = -bt=netware
cflags_linux    = -bt=linux

!ifdef $(proj_name)_rtdll
!ifeq $(proj_name)_rtdll 1
sys_rtdll       = 1
!else
sys_rtdll       = 0
!endif
!endif

!ifndef sys_rtdll
sys_rtdll       = 0
!endif

!ifeq sys_rtdll 1
cflags_nt      += -br
cflags_win     += -br
cflags_os2     += -br
!endif

clflags_nt_386     = -l=nt
clflags_nt_axp     = -l=ntaxp
clflags_win_i86    = -l=windows
clflags_win_386    = -l=windows
clflags_os2_i86    = -l=os2
clflags_os2_386    = -l=os2v2
clflags_qnx_i86    = -l=qnx
clflags_qnx_386    = -l=qnx
clflags_osi_386    = -l=osi
clflags_dos_i86    = -l=dos
clflags_dos_386    = -l=dos4g
clflags_nov_386    = -l=netware
clflags_linux_386  = -l=linux
clflags_linux_ppc  = -l=linux

proj_c_flags     = $(extra_c_flags) $(extra_c_flags_$(host_cpu)) $(extra_c_flags_$(host_os))
cflags           = $(cflags_all) $(cflags_$(host_cpu)) $(cflags_$(host_os)) $(proj_c_flags)
proj_cpp_flags   = $(extra_cpp_flags) $(extra_cpp_flags_$(host_cpu)) $(extra_cpp_flags_$(host_os))
cppflags         = $(cppflags_all) $(proj_cpp_flags)
clflags          = $(mode_clflags) $(clflags_$(host_os)_$(host_cpu)) $(extra_cl_flags) -fe=$^@ -fm

aflags_all      =-w4
!ifdef __LINUX__
aflags_all      += -fo=.obj
!endif

aflags_386      = -3
aflags_i86      =
aflags_axp      =
aflags_ppc      =

aflags_nt       = -bt=nt
aflags_win      = -bt=windows
aflags_os2      = -bt=os2
aflags_qnx      = -bt=qnx
aflags_osi      = -bt=osi
aflags_dos      = -bt=dos
aflags_nov      = -bt=netware
aflags_linux    = -bt=linux

proj_a_flags     = $(extra_a_flags) $(extra_a_flags_$(host_cpu)) $(extra_a_flags_$(host_os))
aflags           = $(aflags_all) $(aflags_$(host_cpu)) $(aflags_$(host_os)) $(mode_aflags) $(proj_a_flags)

lflags_dos_i86   = sys dos
lflags_nt_axp    = sys ntaxp
lflags_nt_386    = sys nt
lflags_os2_386   = sys os2v2
lflags_os2_i86   = sys os2 pmc
lflags_dos_386   = sys dos4g
lflags_qnx_386   = sys qnx386 flat
lflags_qnx_i86   = sys qnx
lflags_win_386   = sys win386
lflags_win_i86   = sys windows
lflags_nov_386   = sys novell
lflags_osi_386   = sys osi
!ifdef __LINUX__
lflags_linux_386 = sys bld_linux
!else
lflags_linux_386 = sys linux
!endif

!ifdef sys_windowed
# this is really stupid
lflags_nt_386   = sys nt_win
lflags_nt_axp   = sys ntaxp_win
lflags_os2_386  = sys os2v2_pm
lflags_os2_i86  = sys os2_pm
!endif
!ifdef sys_dll
#this is equally bad
lflags_nt_386   = sys nt_dll
lflags_nt_axp   = sys ntaxp_dll
lflags_win_i86  = sys windows_dll
lflags_os2_386  = sys os2v2 dll
lflags_os2_i86  = sys os2 dll
!ifndef suppress_bd
cflags_all     += -bd
!endif
!endif

lflags          = $(mode_lflags) $(lflags_$(host_os)_$(host_cpu)) $(extra_l_flags_$(host_os)) $(extra_l_flags)

rc_flags_nt     = -bt=nt
rc_flags_win    = -bt=windows

rc_flags_axp    = -D__AXP__

rc_flags        = $(rc_flags_$(host_os)) $(rc_flags_$(host_cpu))

!ifdef __LINUX__

inc_dirs_sys_os2_386 = -I$(dev_dir)/os2api/incl32
inc_dirs_sys_os2_i86 = -I$(dev_dir)/os2api/incl16
inc_dirs_sys_nt    = -I$(dev_dir)/w32api/include
inc_dirs_sys_win   = -I$(hdr_dir)/dos/win -I$(dev_dir)/w16api/include
inc_dirs_sys_os2   = $(inc_dirs_sys_os2_$(host_cpu))
inc_dirs_sys_dos   =
inc_dirs_sys_nov   =
inc_dirs_sys_qnx   =
inc_dirs_sys_linux =

inc_dirs_lang_qnx     = -I$(hdr_dir)/qnx
inc_dirs_lang_linux   = -I$(hdr_dir)/linux
inc_dirs_lang_netware = -I$(ow_nwoss_root)/common/h

!ifdef inc_dirs_lang_$(host_os)
inc_dirs_lang   = $(inc_dirs_lang_$(host_os))
!else
inc_dirs_lang   = -I$(hdr_dir)/dos
!endif

inc_dirs_sys    = $(inc_dirs_lang) $(inc_dirs_sys_$(host_os))
inc_path        = $(inc_dirs) $(inc_dirs_$(host_os)) $(inc_dirs_sys) -I$(watcom_dir)/h

yacc            = $(bld_bin)/wyacc
re2c            = $(bld_bin)/re2c

!else

inc_dirs_sys_os2_386 = -I$(lang_root)\h\os2
inc_dirs_sys_os2_i86 = -I$(lang_root)\h\os21x
inc_dirs_sys_nt    = -I$(lang_root)\h\nt
inc_dirs_sys_win   = -I$(lang_root)\h\win
inc_dirs_sys_os2   = $(inc_dirs_sys_os2_$(host_cpu))
inc_dirs_sys_dos   =
inc_dirs_sys_nov   =
inc_dirs_sys_qnx   =
inc_dirs_sys_linux =

inc_dirs_lang_qnx     = -I$(lang_root)\qh
inc_dirs_lang_linux   = -I$(lang_root)\lh
inc_dirs_lang_netware = -I$(ow_nwoss_root)\common\h

!ifdef inc_dirs_lang_$(host_os)
inc_dirs_lang   = $(inc_dirs_lang_$(host_os))
!else
inc_dirs_lang   = -I$(lang_root)\h
!endif

inc_dirs_sys    = $(inc_dirs_lang) $(inc_dirs_sys_$(host_os))
inc_path        = $(inc_dirs) $(inc_dirs_$(host_os)) $(inc_dirs_sys) -I$(watcom_dir)\h

yacc            = $(bld_bin)\yacc
re2c            = $(bld_bin)\re2c

!endif

cc              = $(cc_$(host_cpu))
cl              = $(cl_$(host_cpu))
cpp             = $(cpp_$(host_cpu))
linker          = $(linker_$(host_cpu))
librarian       = $(librarian_$(host_cpu))
as              = $(as_$(host_cpu))
vi              = vi -q -d -i
!ifdef __UNIX__
rc_aui          = $(rc) -bt=windows -I$(watcom_dir)/h -zk0 -r
!else
rc_aui          = $(rc) -bt=windows -I$(watcom_dir)\h -zk0 -r
!endif

!include bhost.mif
!include local.mif
