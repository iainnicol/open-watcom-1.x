.387
.386p
		PUBLIC	__SYS_INIT_387_EMULATOR
		PUBLIC	__SYS_FINI_387_EMULATOR
		EXTRN	__8087CW:BYTE
		EXTRN	__8087:BYTE
		EXTRN	__X32VM:BYTE
		EXTRN	__X386_ZERO_BASE_SELECTOR:BYTE
		EXTRN	__EXTENDER:BYTE
		EXTRN	__INT7:BYTE
		EXTRN	__GDAPTR:BYTE
		EXTRN	__D16INFOSEG:BYTE
		EXTRN	__HOOK387:BYTE
		EXTRN	__INT7_PL3:BYTE
		EXTRN	__UNHOOK387:BYTE
DGROUP		GROUP	_DATA
_DATA		SEGMENT	DWORD PUBLIC USE32 'DATA'
L$1:
    DB	07H DUP(0,0,0,0,0,0,0,0)
    DB	0, 0, 0, 0, 0, 0, 0, 0
L$2:
    DB	0, 0, 0, 0
L$3:
    DB	0, 0
L$4:
    DB	0, 0
L$5:
    DB	0

_DATA		ENDS
_TEXT		SEGMENT	WORD PUBLIC USE32 'CODE'
		ASSUME CS:_TEXT, DS:DGROUP, SS:DGROUP
__SYS_INIT_387_EMULATOR:
    push        es
    push        ecx
    push        ebx
    push        edx
    fninit      
    push        eax
    fnstcw      word ptr [esp]
    pop         eax
    cmp         ah,3
    je          L$6
    inc         ebp
L$6:
    or          ebp,ebp
    je          L$7
    call        near ptr L$8
L$7:
    finit       
    fldcw       word ptr DGROUP:__8087CW
    fldz        
    fldz        
    fldz        
    fldz        
    pop         edx
    pop         ebx
    pop         ecx
    pop         es
    ret         
L$8:
    mov         byte ptr DGROUP:__8087,3
    mov         byte ptr DGROUP:L$5,1
    smsw        word ptr DGROUP:L$4
    and         word ptr DGROUP:L$4,6
    sub         esp,8
    sidt        [esp]
    mov         ebx,dword ptr 2[esp]
    add         ebx,38H
    add         esp,8
    cmp         byte ptr DGROUP:__X32VM,0
    je          L$9
    call        near ptr L$13
    mov         es,word ptr DGROUP:__X386_ZERO_BASE_SELECTOR
    mov         dword ptr es:[ebx],edx
    mov         dword ptr es:4[ebx],ecx
    call        near ptr L$17
    cmp         byte ptr DGROUP:__EXTENDER,0
    jne         L$9
    mov         ax,2507H
    push        ds
    mov         cx,cs
    mov         ds,cx
    lea         edx,__INT7
    int         21H
    pop         ds
    mov         al,4
    mov         ah,0f3H
    int         21H
    jmp         L$12
L$9:
    cmp         byte ptr DGROUP:__EXTENDER,9
    jne         L$10
    call        near ptr L$13
    mov         dword ptr [ebx],edx
    mov         dword ptr 4[ebx],ecx
    mov         eax,0e02H
    mov         ebx,4
    mov         ecx,dword ptr DGROUP:__GDAPTR
    call        dword ptr 30H[ecx]
    jmp         L$12
L$10:
    cmp         byte ptr DGROUP:__EXTENDER,1
    jne         L$11
    mov         dx,word ptr DGROUP:__D16INFOSEG
    sub         eax,eax
    call        near ptr __HOOK387
    jmp         L$12
L$11:
    sub         dx,dx
    sub         eax,eax
    call        near ptr __HOOK387
    cmp         al,1
    je          L$12
    call        near ptr L$14
L$12:
    ret         
L$13:
    lea         ecx,__INT7
    mov         dx,cs
    shl         edx,10H
    mov         dx,cx
    mov         cx,cs
    and         cl,3
    shl         cx,0dH
    or          ch,8eH
    ret         
L$14:
    mov         cl,7
    mov         ax,2502H
    int         21H
    mov         dword ptr DGROUP:L$2,ebx
    mov         word ptr DGROUP:L$3,es
    cmp         byte ptr DGROUP:__EXTENDER,3
    mov         cl,7
    mov         ax,2504H
    push        ds
    push        cs
    pop         ds
    jl          L$15
    lea         edx,__INT7_PL3
    int         21H
    pop         ds
    call        near ptr L$17
    jmp         L$16
L$15:
    lea         edx,__INT7
    int         21H
    pop         ds
    mov         ecx,cr0
    or          ecx,4
    and         ecx,0fffffffdH
    mov         cr0,ecx
L$16:
    ret         
L$17:
    xor         ebx,ebx
    lea         edx,DGROUP:L$1
    mov         ax,2535H
    int         21H
    or          dword ptr DGROUP:L$1,4
    and         dword ptr DGROUP:L$1,0fffffffdH
    inc         ebx
    int         21H
    ret         
__SYS_FINI_387_EMULATOR:
    cmp         byte ptr DGROUP:L$5,1
    je          L$18
    ret         
L$18:
    push        ecx
    push        ebx
    push        edx
    mov         al,byte ptr DGROUP:__EXTENDER
    cmp         byte ptr DGROUP:__X32VM,0
    je          L$19
    call        near ptr L$27
    jmp         L$23
L$19:
    cmp         al,9
    jne         L$20
    mov         eax,0e02H
    mov         ebx,0
    mov         ecx,dword ptr DGROUP:__GDAPTR
    call        dword ptr 30H[ecx]
    jmp         L$23
L$20:
    cmp         al,0
    jne         L$21
    mov         ax,word ptr DGROUP:L$4
    mov         ah,0f3H
    int         21H
    jmp         L$23
L$21:
    cmp         al,1
    jne         L$22
    mov         dx,word ptr DGROUP:__D16INFOSEG
    sub         eax,eax
    call        near ptr __UNHOOK387
    jmp         L$23
L$22:
    sub         edx,edx
    call        near ptr __UNHOOK387
    cmp         al,1
    je          L$23
    call        near ptr L$24
L$23:
    mov         byte ptr DGROUP:L$5,0
    pop         edx
    pop         ebx
    pop         ecx
    ret         
L$24:
    mov         cl,7
    mov         ax,2504H
    mov         edx,dword ptr DGROUP:L$2
    push        ds
    mov         ds,word ptr DGROUP:L$3
    int         21H
    pop         ds
    cmp         byte ptr DGROUP:__EXTENDER,3
    jl          L$25
    call        near ptr L$27
    jmp         L$26
L$25:
    mov         ecx,cr0
    and         ecx,0fffffff9H
    mov         dx,word ptr DGROUP:L$4
    or          cx,dx
    mov         cr0,ecx
L$26:
    ret         
L$27:
    xor         ebx,ebx
    lea         edx,DGROUP:L$1
    mov         ax,2535H
    int         21H
    xor         ecx,ecx
    mov         cx,word ptr DGROUP:L$4
    mov         dword ptr DGROUP:L$1,ecx
    inc         ebx
    int         21H
    ret         
_TEXT		ENDS
		END
