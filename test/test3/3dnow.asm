.586
.k3d
.model small

.data
one dq 1.0
bnd dq 0.575
mabs dq 7fffffffh
pio2 dq 1.57
sgn dq 0
npio2 dq -1.57

.code

MOVQ MM3, MM0
MOVQ MM4, one
PFCMPGE MM0, MM1
PSLLD MM0, 31
PXOR MM0, MM4
PFADD MM0, MM2

MOVQ MM5, mabs
PAND MM0, MM5
PFRCP MM2, MM0
MOVQ MM1, MM0
PFRCPIT1 MM0, MM2
PFRCPIT2 MM0, MM2
PFMIN MM0, MM1

MOVQ MM7, mabs
PAND MM0, MM7
MOVQ MM2, bnd
PCMPGTD MM2, MM0
MOVQ MM3, pio2
MOVQ MM0, MM1
PFADD MM1, MM1
PFSUBR MM1, MM3
PAND MM0, MM2
PANDN MM2, MM1
POR MM0, MM2

MOVQ MM5, mabs
MOVQ MM6, one
PAND MM0, MM5
PCMPGTD MM6, MM0
MOVQ MM4, pio2
PFSUB MM4, MM1
PANDN MM6, MM4
PFMAX MM1, MM6

MOVQ MM7, sgn
MOVQ MM6, sgn
MOVQ MM5, mabs
PAND MM7, MM2
PAND MM1, MM5
PAND MM2, MM5
MOVQ MM6, MM1
PCMPGTD MM6, MM2
PSLLD MM6, 31
MOVQ MM5, MM7
PXOR MM7, MM6
MOVQ MM3, npio2
PXOR MM5, MM3
PSRAD MM6, 31
PANDN MM6, MM5
PFSUB MM6, MM3
POR MM0, MM7
PFADD MM0, MM6

end
